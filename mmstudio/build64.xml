<!-- Ant makefile for the Micro-Manager for Windows distribution -->
<!-- This file assumes Micro-Manager project tree structure      -->

<project name="MMJ" default="build">

	<!-- Specify version in the installer name -->
	<property name="InstallerName" value="MMSetup_"/>

	<!-- Specify the system path to the ImageJ root directory -->
	<property name="ImageJPath" value="/Program Files/ImageJ"/>
	<property name="InstallRoot" value="../Install_x64/micro-manager"/>
	<property name="NativeRoot" value="../MMCoreJ_wrap"/>
        <property name="ScriptsRoot" value="../scripts"/>
        <property name="ScriptsInstall" value="../Install_x64/micro-manager/scripts"/>
        <property name="DriversRoot" value="../drivers"/>
        <property name="DriversInstall" value="../Install_x64/micro-manager/drivers"/>

	<!-- Do not modify from this point on -->
	<property name="MMPluginDir" value="${ImageJPath}/plugins/Micro-Manager"/>
	<property name="IJ" value="../../3rdpartypublic/classext/ij.jar"/>
	<property name="beanshell" value="../../3rdpartypublic/classext/bsh-2.0b4.jar"/>
	<property name="swingx" value="../../3rdpartypublic/classext/swingx-0.9.5.jar"/>
	<property name="swing_layout" value="../../3rdpartypublic/classext/swing-layout-1.0.4.jar"/>
	<property name="commons_math" value="../../3rdpartypublic/classext/commons-math-2.0.jar"/>
	<property name="MMCoreJ" value="../bin_x64/MMCoreJ.jar"/>
	<property name="MMPluginDir-inst" value="${InstallRoot}/plugins/Micro-Manager"/>
	<property name="BinRoot" value="../bin_x64"/>

	<path id="project.MMPlugins.path">
		<pathelement location="${MMPluginDir}"/>
	</path>

	<path id="project.run.path">
		<pathelement location="${MMPluginDir}/MMJ_.jar"/>
		<pathelement location="${MMPluginDir}/MMCoreJ.jar"/>
		<pathelement location="${MMPluginDir}/bsh-2.0b4.jar"/>
		<pathelement location="${MMPluginDir}/swingx-0.9.5.jar"/>
		<pathelement location="${MMPluginDir}/swing-layout-1.0.4.jar"/>
    	<pathelement location="${MMPluginDir}/commons-math-2.0.jar"/>
		<pathelement location="${IJ}"/>
	</path>

	<path id="project.class.path">
		<pathelement location="${IJ}" />
		<pathelement location="${beanshell}" />
		<pathelement location="${swingx}" />
		<pathelement location="${MMCoreJ}" />
		<pathelement location="${swing_layout}" />
		<pathelement location="${commons_math}" />
		<pathelement location="${MMPluginDir}/MMJ_.jar"/>
	</path>

	<target name="compile" description="Compile MM Studio.">
		<mkdir dir="build" />
		<javac srcdir="./src" destdir="./build" sourcepath="./src/org/micromanager/utils/AutofocusBase.java" optimize="on" source="1.5" target="1.5" debug="on">
			
			<classpath refid="project.class.path" />
			<!-- <compilerarg value="-Xlint"/> -->
		</javac>
		<copy file="./src/org/micromanager/icons/splash.gif" todir="./build/org/micromanager/icons" />
		<copy todir="./build/org/micromanager/icons">
			<fileset dir="./src/org/micromanager/icons" casesensitive="no">
				<include name="**/*.png"/>
				<include name="**/*.gif"/>
			</fileset>
		</copy>
		<copy todir="./build/org/micromanager/conf">
			<fileset dir="./src/org/micromanager/conf" casesensitive="no">
				<include name="**/*.html"/>
			</fileset>
		</copy>
	</target>

	<target name="build" description="Build MMJ_.jar">

		<copy file="./bin/plugins_mmstudio.config" tofile="./build/plugins.config"  overwrite="true" verbose="true" />
		<jar jarfile="MMJ_.jar" basedir="build" manifest="./src/MANIFEST.MF" />

		<mkdir dir="${MMPluginDir}" />
		<copy file="MMJ_.jar" todir="${MMPluginDir}" />
		<copy file="${beanshell}" todir="${MMPluginDir}" />
		<copy file="${swingx}" todir="${MMPluginDir}" />
		<copy file="${MMCoreJ}" todir="${MMPluginDir}" />
		<copy file="${swing_layout}" todir="${MMPluginDir}" />
		<copy file="${commons_math}" todir="${MMPluginDir}" />		
	</target>

	<target name="buildMMReader" description="Build MMReader_.jar">

		<copy file="./bin/plugins_reader.config" tofile="./build/plugins.config" overwrite="true" verbose="true"/>
		<jar jarfile="MMReader_.jar" basedir="build" manifest="./src/MANIFEST.MF" />

	</target>

	<target name="clean" description="Delete the MMStudio build files.">
		<delete dir="build" />
		<delete file="MMJ_.jar" />
		<delete file="MMReader_.jar" />
	</target>
	

	<target name="install" description="Create installation image">
		<copy file="${ImageJPath}/ImageJ.exe" todir="${InstallRoot}" />
		<copy file="${IJ}" todir="${InstallRoot}" />
		<copy file="MMJ_.jar" todir="${MMPluginDir-inst}" />
		<copy file="MMJ_.jar" todir="${BinRoot}/plugins/Micro-Manager" />
		<copy file="${beanshell}" todir="${MMPluginDir-inst}" />
		<copy file="${swingx}" todir="${MMPluginDir-inst}" />
		<copy file="${MMCoreJ}" todir="${MMPluginDir-inst}" />		
		<copy file="${swing_layout}" todir="${MMPluginDir-inst}" />
		<copy file="${commons_math}" todir="${MMPluginDir-inst}" />
		<copy file="${BinRoot}/MMCoreJ_wrap.dll" todir="${InstallRoot}" />
		<copy file="${BinRoot}/LaunchMicroManager.bat" todir="${InstallRoot}" />
		<copy file="${BinRoot}/MMConfig_demo.cfg" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_AAAOTF.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_AndorLaserCombiner.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Arduino.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_ASIFW1000.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_ASIStage.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_ASIwptr.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_CoherentCube.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Conix.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Corvus.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_CSUX.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_DemoCamera.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_DemoStreamingCamera.dll" todir="${InstallRoot}" />
		<copy file="${BinRoot}/mmgr_dal_FreeSerialPort.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_GenericSLM.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Hamamatsu.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_K8055.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_K8061.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_LeicaDMI.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_LeicaDMR.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Ludl.dll" todir="${InstallRoot}" />
		<copy file="${BinRoot}/mmgr_dal_MaestroServo.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Marzhauser.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_MT20.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Neos.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Nikon.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_NikonAZ100.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_NikonTE2000.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_NikonTI.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Olympus.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_ParallelPort.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Pecon.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_PI.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_PI_GCS.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_PrecisExcite.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Prior.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_SerialManager.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_SimpleAutofocus.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_SpectralLMM5.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_SpotCamera.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_SutterLambda.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_ThorlabsFilterWheel.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_ThorlabsSC10.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_TIScam.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_TwainCamera.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_USBManager.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Utilities.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Vincent.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_Yokogawa.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_ZeissCAN.dll" todir="${InstallRoot}" />
<copy file="${BinRoot}/mmgr_dal_ZeissCAN29.dll" todir="${InstallRoot}" />

    <copy file="${ScriptsRoot}/sdemo1.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/sdemo2.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/setZoom.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/camera_test.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/image_snap_example.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/image_snap_example_2.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/live_demo.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/manualAcq.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/Init.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/config_test.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/AutoExpose.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/slm_demo.bsh" todir="${ScriptsInstall}" /> 
    <copy file="${ScriptsRoot}/mm_beanshell_startup.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/mm_load_docs.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/mm_inspector.bsh" todir="${ScriptsInstall}" />     
    <copy file="${ScriptsRoot}/mm_test_all.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/mm_test_camera.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/mm_test_properties.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/mm_test_shutter.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/mm_test_xystage.bsh" todir="${ScriptsInstall}" />
    <copy file="${ScriptsRoot}/mm_test_zstage.bsh" todir="${ScriptsInstall}" />
    <copy file="${DriversRoot}/K8055_libusb.inf" todir="${DriversInstall}" />
    <copy file="${DriversRoot}/K8055_libusb.cat" todir="${DriversInstall}" />
    <copy file="${DriversRoot}/K8061_libusb.inf" todir="${DriversInstall}" />
    <copy file="${DriversRoot}/K8061_libusb.cat" todir="${DriversInstall}" />
    <copy file="${DriversRoot}/NikonAZ100.inf" todir="${DriversInstall}" />
    <copy file="${DriversRoot}/NikonAZ100.cat" todir="${DriversInstall}" />
    <copy file="${DriversRoot}/libusb0.dll" todir="${DriversInstall}" />
    <copy file="${DriversRoot}/libusb0.dll" todir="${InstallRoot}" />
    <copy file="${DriversRoot}/libusb0.sys" todir="${DriversInstall}" />

	</target>


	<target name="makeDeviceList" description="Run DeviceListBuilder to generate MMDeviceList.txt">
		<exec dir="${InstallRoot}" executable="java">
			<arg line="-cp plugins\Micro-Manager\MMJ_.jar;plugins\Micro-Manager\MMCoreJ.jar DeviceListBuilder "/>
		</exec>
	<!--	<copy file="${InstallRoot}/MMDeviceList.txt" todir="${BinRoot}" /> -->
	</target>

	<target name="packInstaller" description="Create installation package">
		<exec dir="${InstallRoot}" executable="/projects/3rdparty/Inno_Setup_5/iscc.exe">
			<arg line="/F${InstallerName} ../MM-ImageJ-Install64.iss"/>
		</exec>
	</target>

</project>
