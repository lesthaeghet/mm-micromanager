///////////////////////////////////////////////////////////////////////////////
// AUTHOR:       Henry Pinkard, henry.pinkard@gmail.com
//
// COPYRIGHT:    University of California, San Francisco, 2015
//
// LICENSE:      This file is distributed under the BSD license.
//               License text is included with the source distribution.
//
//               This file is distributed in the hope that it will be useful,
//               but WITHOUT ANY WARRANTY; without even the implied warranty
//               of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
//
//               IN NO EVENT SHALL THE COPYRIGHT OWNER OR
//               CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
//               INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES.
//
package propsandcovariants;

import java.util.ArrayList;
import java.util.Arrays;
import misc.Log;

/**
 *
 * wrapper class that holds precalculated values of relative power based on
 * vertical distance, surface normal value, and radius of curvature
 */
public class CurvedSurfaceCalculations {

   //mean free paths for which vals have been calculated
   private static Integer[] MEAN_FREE_PATHS = new Integer[]{25, 30, 70, 80, 90, 200};
   private static Integer[] RADII_OF_CURVATURE = new Integer[]{400,600, 800};
   //ponts at which relative power has been calculated
   private static int DISTANCE_INCREMENT = 20;
   private static int NORMAL_INCREMENT = 10;
   //[radius of curvature][mean free path][normal][vertical distance]
   private static final double[][][][] RELATIVE_POWERS = new double[][][][]{
      //radius = 400
      {
         //MFP 25
         null,
         //MFP 30 
         null,
         //MFP 70
         null,
         //MFP 80
         null,
         //MFP 90 
         null,
         //MFP 200
         null 
      },
      
      //radius = 600
      {
         //MFP 25
         {{1.000000, 2.174786, 3.541065, 4.954333, 6.362246, 7.747367, 9.103893, 10.430151, 11.726072, 12.992232, 14.229470, 15.438688, 16.620785, 17.776623, 18.906996, 20.012631, 20.012631},
            {1.000000, 2.175716, 3.627874, 5.167263, 6.704800, 8.209957, 9.674738, 11.098561, 12.483040, 13.830283, 15.142370, 16.421179, 17.668389, 18.885474, 20.073725, 21.234277, 21.234277},
            {1.000000, 2.201904, 3.737349, 5.399660, 7.067488, 8.693679, 10.265752, 11.783590, 13.250619, 14.670816, 16.047848, 17.384860, 18.684529, 19.949115, 21.180535, 22.380430, 22.380430},
            {1.001226, 2.265090, 3.871861, 5.640161, 7.427717, 9.168857, 10.842880, 12.448023, 13.988782, 15.470949, 16.899968, 18.280520, 19.616493, 20.911127, 22.167106, 23.386671, 23.386671},
            {1.045289, 2.364991, 4.007222, 5.837545, 7.709689, 9.541586, 11.300083, 12.977555, 14.576981, 16.104715, 17.567486, 18.971368, 20.321540, 21.622271, 22.877104, 24.088944, 24.088944},
            {1.137428, 2.472289, 4.077402, 5.880016, 7.753117, 9.608894, 11.400912, 13.110555, 14.734211, 16.275092, 17.738847, 19.131554, 20.458787, 21.725375, 22.935278, 24.091735, 24.091735},
            {1.264403, 2.537961, 3.987980, 5.608103, 7.312692, 9.029158, 10.708146, 12.320924, 13.853230, 15.299594, 16.659260, 17.933608, 19.124592, 20.233936, 21.262453, 22.209840, 22.209840},
            {1.419380, 2.511839, 3.644292, 4.856682, 6.105746, 7.347461, 8.544639, 9.667713, 10.693122, 11.600893, 12.372075, 12.986218, 13.418782, 13.638386, 13.603617, 13.259714, 13.259714},
            {1.606216, 2.333508, 2.946511, 3.487644, 3.929590, 4.239715, 4.384894, 4.332988, 4.054204, 3.521579, 2.690510, 2.559137, 2.995353, 3.142031, 3.063054, 2.866097, 2.866097},
            {1.839451, 1.951261, 2.158980, 2.424089, 2.695474, 2.910300, 3.017094, 3.001328, 2.887038, 2.717558, 2.531728, 2.353895, 2.195489, 2.059955, 1.946914, 1.854750, 1.854750},},
         //MFP 30
         {{1.000000, 1.956162, 3.062142, 4.216545, 5.374378, 6.517948, 7.640522, 8.739686, 9.814809, 10.866024, 11.893796, 12.898725, 13.881446, 14.842592, 15.782769, 15.782769},
            {1.000000, 1.950023, 3.110374, 4.357412, 5.619179, 6.863916, 8.080026, 9.264360, 10.416978, 11.539048, 12.632028, 13.697370, 14.736418, 15.750369, 16.740292, 16.740292},
            {1.000000, 1.966496, 3.180014, 4.513880, 5.876458, 7.221048, 8.529177, 9.795824, 11.021389, 12.208105, 13.358597, 14.475363, 15.560622, 16.616293, 17.644024, 17.644024},
            {1.001054, 2.016392, 3.275711, 4.679904, 6.128983, 7.563390, 8.956015, 10.297996, 11.588862, 12.831369, 14.029150, 15.185780, 16.304454, 17.387918, 18.438499, 18.438499},
            {1.041797, 2.102914, 3.382635, 4.820075, 6.319745, 7.815051, 9.270060, 10.669686, 12.010258, 13.293417, 14.522834, 15.702640, 16.836755, 17.928647, 18.981287, 18.981287},
            {1.129420, 2.205711, 3.453737, 4.854501, 6.330998, 7.820231, 9.281358, 10.692266, 12.043373, 13.332343, 14.560530, 14.600000, 14.800000, 15.000000, 16.000000, 16.000000},
            {1.282357, 2.201728, 3.200110, 4.279121, 5.381698, 6.458291, 7.473654, 8.404912, 9.237535, 9.961323, 10.560946, 12.800000, 12.000000, 13.000000, 14.000000, 14.000000},
            {1.435294, 2.197745, 2.946482, 3.703740, 4.432399, 5.096350, 5.665950, 6.117558, 6.431698, 6.590303, 6.561362, 10.429641, 10.766784, 10.940900, 11.000000, 11.000000},
            {1.588231, 2.193761, 2.692854, 3.128359, 3.483099, 3.734409, 3.858246, 3.830204, 3.625860, 3.219283, 2.561777, 2.446063, 2.812709, 2.964646, 2.929796, 2.929796}},
         //MFP 70
         {{1.000000, 1.376873, 1.787457, 2.219775, 2.664243, 3.113765, 3.563373, 4.009741, 4.450724, 4.884995, 5.311774, 5.730638, 6.141391, 6.543978, 6.938428, 7.324820, 7.324820},
            {1.000000, 1.366904, 1.776624, 2.217871, 2.679961, 3.153834, 3.632400, 4.110451, 4.584352, 5.051699, 5.510982, 5.961319, 6.402260, 6.833629, 7.255429, 7.667769, 7.667769},
            {1.000000, 1.368372, 1.780993, 2.230077, 2.705795, 3.198646, 3.700422, 4.204564, 4.706155, 5.201708, 5.688889, 6.166235, 6.632915, 7.088537, 7.532999, 7.966382, 7.966382},
            {1.000495, 1.387236, 1.805090, 2.259329, 2.742529, 3.245987, 3.761438, 4.281768, 4.801278, 5.315658, 5.821832, 6.317726, 6.802044, 7.274062, 7.733458, 8.180185, 8.180185},
            {1.025821, 1.431679, 1.851194, 2.303090, 2.782668, 3.282749, 3.795902, 4.315332, 4.835275, 5.351114, 5.859337, 6.357398, 6.843548, 7.316660, 7.776069, 8.221451, 8.221451},
            {1.088091, 1.501804, 1.912475, 2.347475, 2.804613, 3.278593, 3.763482, 4.253577, 4.743807, 5.229885, 5.708336, 6.176431, 6.632089, 7.073754, 7.500280, 7.910818, 7.910818},
            {1.184674, 1.588519, 1.970675, 2.364244, 2.769140, 3.181880, 3.598144, 4.013558, 4.424010, 4.825772, 5.215522, 5.590305, 5.947449, 6.284480, 6.598996, 6.888550, 6.888550},
            {1.313062, 1.674683, 1.995293, 2.309214, 2.617387, 2.917213, 3.205030, 3.476769, 3.728154, 3.954723, 4.151768, 4.314204, 4.436391, 4.511906, 4.533253, 4.491499, 4.491499},
            {1.472853, 1.733097, 1.937007, 2.110751, 2.253736, 2.361859, 2.429346, 2.448914, 2.411098, 2.301763, 2.088925, 2.034546, 2.180012, 2.274927, 2.313898, 2.298900, 2.298900},
            {1.670585, 1.726493, 1.805491, 1.900235, 2.001403, 2.097725, 2.177045, 2.228448, 2.244833, 2.225295, 2.174909, 2.102574, 2.018325, 1.931215, 1.848253, 1.774318, 1.774318},},
         //MFP 80
         {{1.000000, 1.326725, 1.678791, 2.048126, 2.427964, 2.812991, 3.199231, 3.583826, 3.964790, 4.340786, 4.710946, 5.074736, 5.431844, 5.782113, 6.125488, 6.461975, 6.461975},
            {1.000000, 1.317517, 1.667019, 2.041051, 2.432355, 2.834496, 3.242142, 3.651106, 4.058246, 4.461297, 4.858694, 5.249398, 5.632764, 6.008421, 6.376197, 6.736046, 6.736046},
            {1.000000, 1.318424, 1.669108, 2.047515, 2.447308, 2.862053, 3.285891, 3.713841, 4.141901, 4.566994, 4.986862, 5.399916, 5.805098, 6.201746, 6.589496, 6.968187, 6.968187},
            {1.000437, 1.334778, 1.689120, 2.070305, 2.474061, 2.894792, 3.326853, 3.765097, 4.205121, 4.643347, 5.076998, 5.504005, 5.922897, 6.332681, 6.732734, 7.122710, 7.122710},
            {1.023553, 1.374573, 1.729962, 2.108364, 2.507681, 2.923517, 3.350969, 3.785286, 4.222200, 4.658073, 5.089931, 5.515438, 5.932820, 6.340785, 6.738428, 7.125145, 7.125145},
            {1.081539, 1.439157, 1.787239, 2.151637, 2.532067, 2.925419, 3.327829, 3.735370, 4.144368, 4.551554, 4.954123, 5.349740, 5.736495, 6.112854, 6.477594, 6.829728, 6.829728},
            {1.172665, 1.521906, 1.846924, 2.178038, 2.516354, 2.859879, 3.205744, 3.550868, 3.892224, 4.226957, 4.552420, 4.866171, 5.165931, 5.449532, 5.714838, 5.959665, 5.959665},
            {1.295395, 1.609032, 1.883899, 2.150814, 2.411406, 2.664091, 2.906269, 3.134897, 3.346686, 3.538135, 3.705497, 3.844691, 3.951174, 4.019763, 4.044403, 4.017856, 4.017856},
            {1.449588, 1.677141, 1.855184, 2.006932, 2.132405, 2.228492, 2.290552, 2.312542, 2.286382, 2.199691, 2.024152, 1.977933, 2.102376, 2.186742, 2.225758, 2.219350, 2.219350},
            {1.640895, 1.692753, 1.763331, 1.846784, 1.935653, 2.020928, 2.092799, 2.142138, 2.162419, 2.151746, 2.113109, 2.053106, 1.979999, 1.901890, 1.825576, 1.756187, 1.756187},},
         //MFP 90
         {{1.000000, 1.288286, 1.596022, 1.917581, 2.248076, 2.583494, 2.920679, 3.257234, 3.591394, 3.921893, 4.247850, 4.568672, 4.883973, 5.193521, 5.497186, 5.497186},
            {1.000000, 1.279781, 1.584052, 1.907682, 2.245574, 2.593059, 2.946107, 3.301400, 3.656308, 4.008818, 4.357440, 4.701105, 5.039074, 5.370863, 5.696172, 5.696172},
            {1.000000, 1.280337, 1.584774, 1.910662, 2.253768, 2.609614, 2.973957, 3.343030, 3.713645, 4.083216, 4.449715, 4.811608, 5.167777, 5.517436, 5.860064, 5.860064},
            {1.000391, 1.294774, 1.601857, 1.929096, 2.274046, 2.633004, 3.002048, 3.377422, 3.755769, 4.134217, 4.510402, 4.882443, 5.248897, 5.608691, 5.961061, 5.961061},
            {1.021647, 1.330817, 1.638549, 1.962862, 2.303119, 2.656584, 3.019946, 3.389838, 3.763100, 4.136912, 4.508850, 4.876900, 5.239438, 5.595186, 5.943166, 5.943166},
            {1.075882, 1.390637, 1.692120, 2.004541, 2.328665, 2.662677, 3.004004, 3.349881, 3.697612, 4.044703, 4.388921, 4.728322, 5.061243, 5.386277, 5.702240, 5.702240},
            {1.162047, 1.469396, 1.751611, 2.036511, 2.325841, 2.618510, 2.912571, 3.205796, 3.495909, 3.780686, 4.058005, 4.325845, 4.582277, 4.825421, 5.053405, 5.053405},
            {1.279375, 1.555931, 1.796142, 2.027862, 2.253083, 2.470870, 2.679328, 2.876123, 3.058659, 3.224122, 3.369462, 3.491329, 3.585976, 3.649114, 3.675717, 3.675717},
            {1.428078, 1.630085, 1.788115, 1.922932, 2.034927, 2.121671, 2.179338, 2.202806, 2.185072, 2.115186, 1.967917, 1.928475, 2.036901, 2.112577, 2.150098, 2.150098}
         },
         //MFP 200
         null
      },
      //radius = 800
      {
         //MFP 25
         null,
         //MFP 30
         null,
         //MFP 70
         null,
         //MFP 80
         null,
         //MFP 90
         null,
         //MFP 200
         {{1.000000, 1.126053, 1.255071, 1.386674, 1.520457, 1.656015, 1.792959, 1.930919, 2.069548, 2.208531, 2.347578, 2.486430, 2.624856, 2.762649, 2.899630, 3.035639, 3.170540, 3.304214, 3.436560, 3.567491, 3.696933, 3.824825, 3.951115, 4.075759, 4.198723, 4.319976, 4.439495, 4.557260, 4.673255, 4.787468, 4.899887, 5.010505, 5.119313, 5.226306, 5.331477, 5.434820, 5.536330, 5.636001, 5.733825, 5.829795, 5.923904, 5.923904},
            {1.000000, 1.121669, 1.247169, 1.376180, 1.508323, 1.643193, 1.780379, 1.919475, 2.060089, 2.201847, 2.344401, 2.487424, 2.630618, 2.773710, 2.916453, 3.058624, 3.200028, 3.340489, 3.479852, 3.617984, 3.754767, 3.890100, 4.023896, 4.156081, 4.286593, 4.415378, 4.542391, 4.667597, 4.790964, 4.912466, 5.032084, 5.149800, 5.265600, 5.379473, 5.491408, 5.601397, 5.709433, 5.815508, 5.919616, 6.021748, 6.121898, 6.121898},
            {1.000000, 1.121797, 1.246407, 1.374317, 1.505469, 1.639630, 1.776486, 1.915692, 2.056885, 2.199703, 2.343792, 2.488810, 2.634432, 2.780355, 2.926296, 3.071994, 3.217212, 3.361732, 3.505361, 3.647923, 3.789265, 3.929248, 4.067752, 4.204672, 4.339915, 4.473401, 4.605062, 4.734839, 4.862681, 4.988545, 5.112393, 5.234195, 5.353924, 5.471554, 5.587066, 5.700442, 5.811664, 5.920716, 6.027584, 6.132250, 6.234699, 6.234699},
            {1.000240, 1.129614, 1.255469, 1.383179, 1.513477, 1.646467, 1.782022, 1.919909, 2.059846, 2.201522, 2.344617, 2.488810, 2.633786, 2.779241, 2.924887, 3.070449, 3.215673, 3.360322, 3.504178, 3.647041, 3.788730, 3.929079, 4.067940, 4.205180, 4.340680, 4.474331, 4.606040, 4.735721, 4.863297, 4.988700, 5.111869, 5.232748, 5.351284, 5.467429, 5.581138, 5.692367, 5.801072, 5.907209, 6.010733, 6.111596, 6.209749, 6.209749},
            {1.014549, 1.152078, 1.278844, 1.405596, 1.533865, 1.664081, 1.796301, 1.930411, 2.066212, 2.203457, 2.341876, 2.481184, 2.621095, 2.761325, 2.901597, 3.041644, 3.181213, 3.320060, 3.457959, 3.594696, 3.730071, 3.863899, 3.996005, 4.126227, 4.254416, 4.380430, 4.504135, 4.625406, 4.744123, 4.860169, 4.973431, 5.083796, 5.191150, 5.295377, 5.396357, 5.493961, 5.588054, 5.678487, 5.765097, 5.847702, 5.926098, 5.926098},
            {1.053485, 1.193709, 1.318752, 1.441976, 1.565386, 1.689625, 1.814871, 1.941096, 2.068166, 2.195882, 2.324014, 2.452310, 2.580507, 2.708339, 2.835541, 2.961848, 3.087002, 3.210750, 3.332845, 3.453044, 3.571111, 3.686815, 3.799927, 3.910218, 4.017459, 4.121420, 4.221862, 4.318540, 4.411194, 4.499550, 4.583309, 4.662147, 4.735706, 4.803583, 4.865325, 4.920410, 4.968236, 5.008099, 5.039168, 5.060448, 5.070735, 5.070735},
            {1.117843, 1.254780, 1.373555, 1.488589, 1.602105, 1.714841, 1.827033, 1.938684, 2.049677, 2.159823, 2.268892, 2.376620, 2.482728, 2.586917, 2.688880, 2.788296, 2.884832, 2.978146, 3.067879, 3.153654, 3.235075, 3.311716, 3.383122, 3.448795, 3.508186, 3.560689, 3.605614, 3.642183, 3.669496, 3.686503, 3.691967, 3.684404, 3.662009, 3.622544, 3.563171, 3.480179, 3.368503, 3.220762, 3.024945, 2.756552, 2.292762, 2.292762},
            {1.208915, 1.332958, 1.437445, 1.536059, 1.630922, 1.722711, 1.811595, 1.897505, 1.980240, 2.059508, 2.134955, 2.206172, 2.272701, 2.334031, 2.389596, 2.438766, 2.480834, 2.515001, 2.540353, 2.555827, 2.560168, 2.551857, 2.529003, 2.489155, 2.428943, 2.343257, 2.222875, 2.042219, 1.972692, 2.006406, 2.012062, 1.995639, 1.962549, 1.918134, 1.867426, 1.814896, 1.764312, 1.718826, 1.681284, 1.656083, 1.644940, 1.644940},
            {1.328509, 1.421851, 1.496882, 1.563513, 1.623121, 1.675906, 1.721593, 1.759623, 1.789193, 1.809236, 1.818325, 1.814460, 1.794520, 1.752370, 1.680375, 1.731156, 1.774923, 1.811097, 1.838344, 1.855501, 1.862010, 1.857936, 1.844031, 1.821621, 1.792468, 1.758600, 1.722133, 1.685149, 1.649607, 1.617336, 1.590152, 1.570474, 1.563019, 1.557220, 1.551328, 1.545349, 1.539287, 1.533150, 1.526938, 1.520659, 1.514314, 1.514314},
            {1.480502, 1.507088, 1.537568, 1.571191, 1.607012, 1.643904, 1.680568, 1.715567, 1.747389, 1.774493, 1.795518, 1.809264, 1.815030, 1.812567, 1.802128, 1.784446, 1.760662, 1.732208, 1.700696, 1.667803, 1.635182, 1.604442, 1.577082, 1.554800, 1.540454, 1.536065, 1.531552, 1.526869, 1.522028, 1.517040, 1.511916, 1.506668, 1.501300, 1.495823, 1.490243, 1.484566, 1.478799, 1.472944, 1.467008, 1.460996, 1.454909, 1.454909}
         }
      }
   };

   public static double getRelativePower(int meanFreePath, double vertDistance, double normal, int radiusOfCurvature) {
      int mfpIndex = Arrays.asList(MEAN_FREE_PATHS).indexOf(meanFreePath);
      int radiusIndex = Arrays.asList(RADII_OF_CURVATURE).indexOf(radiusOfCurvature);
      if (mfpIndex == -1) {
         Log.log("Couldn't find mean free path in precalculated values");
         throw new RuntimeException();
      }
      if (radiusIndex == -1) {
         Log.log("Couldn't find radius of curvature in precalculated values");
         throw new RuntimeException();
      }
      double indexedDistance = vertDistance / DISTANCE_INCREMENT;
      int normalIndex = (int) Math.round(normal / NORMAL_INCREMENT); //this one should never exceed 90 degrees so we can round
      double[] distanceVec = RELATIVE_POWERS[radiusIndex][mfpIndex][normalIndex];
      if (indexedDistance > distanceVec.length - 1) {
         return distanceVec[distanceVec.length - 1];
      } else {
         double weight = indexedDistance % 1;
         return (1 - weight) * distanceVec[(int) Math.floor(indexedDistance)] + weight * distanceVec[(int) Math.ceil(indexedDistance)];
      }
   }

   public static String[] getAvailableMeanFreePathLengths(int radius) {
      ArrayList<String> mfps = new ArrayList<String>();
      for (int radiusIndex = 0; radiusIndex < RADII_OF_CURVATURE.length; radiusIndex++) {
         if (radius == RADII_OF_CURVATURE[radiusIndex]) {
            for (int mfpIndex = 0; mfpIndex < MEAN_FREE_PATHS.length; mfpIndex++) {
               if (RELATIVE_POWERS[radiusIndex][mfpIndex] != null) {
                  mfps.add(MEAN_FREE_PATHS[mfpIndex] + "");
               }
            }
            String[] arr = new String[mfps.size()];
            return mfps.toArray(arr);
         }
      }
      throw new RuntimeException("Radius of curvature not found");
   }

   public static String[] getAvailableRadiiOfCurvature() {
      String[] vals = new String[RADII_OF_CURVATURE.length];
      for (int i = 0; i < vals.length; i++) {
         vals[i] = RADII_OF_CURVATURE[i] + "";
      }
      return vals;
   }
}
